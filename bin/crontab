#!/usr/bin/php
<?php

//For easy use.

use Hexmedia\Crontab\Reader\SystemReader;
use Hexmedia\Crontab\Crontab;
use Hexmedia\Crontab\ReaderFactory;
use Hexmedia\Crontab\Writer\SystemWriter;


if (is_file($autoload = getcwd() . '/vendor/autoload.php')) {
    require $autoload;
} else if (is_file($autoload = getcwd() . '/../../autoload.php')) {
    require $autoload;
} else if (is_file($autoload = __DIR__ . '/../vendor/autoload.php')) {
    require($autoload);
} else if (is_file($autoload = __DIR__ . '/../../../autoload.php')) {
    require($autoload);
} else {
    fwrite(STDERR,
        'You must set up the project dependencies, run the following commands:' . PHP_EOL .
        'curl -s http://getcomposer.org/installer | php' . PHP_EOL .
        'php composer.phar install' . PHP_EOL
    );
    exit(1);
}

if ($argc < 2) {
    error_log("Too less arguments for crontab.");
}

$action = null;
$user = null;
$file = null;
$type = 'ini';
$name = null;
$machine = null;

foreach ($argv as $i => $arg) {
    switch ($arg) {
        case "synchronize":
            if (null === $action) {
                $action = "synchronize";
            } else {
                error_log("Cannot call two actions at once");
            }
            break;
        case "echo":
            if (null === $action) {
                $action = "echo";
            } else {
                error_log("Cannot call two actions at once");
            }
            break;
        case "--user":
            $user = $argv[$i + 1];
            unset($argv[$i + 1]);
            break;
        case "--file":
            $file = $argv[$i + 1];
            unset($argv[$i + 1]);
            break;
        case "--type":
            $type = $argv[$i + 1];
            unset($argv[$i + 1]);
            break;
        case "--name":
            $name = $argv[$i + 1];
            unset($argv[$i + 1]);
            break;
        case "--machine":
            $machine = $argv[$i + 1];
            unset($argv[$i + 1]);
            break;
    }
}

if (null === $file) {
    error_log("Configuration file not provided.");
    exit;
}

switch ($action) {
    case "synchronize":
    case "echo":
        $conf = array();

        if (null !== $user) {
            $conf['user'] = $user;
        }

        $crontab = new Crontab($user, $name);

        if (null !== $machine) {
            $conf['machine'] = $machine;
        }

        $conf['crontab'] = $crontab;
        $conf['type'] = 'unix';

        $conf['user'] = "./Tests/example_configurations/test.unix";

        $systemReader = ReaderFactory::create($conf);

        $conf['user'] = $user;

//        $systemReader = new SystemReader($crontab, $conf);

        $conf['file'] = $file;

        $conf['type'] = $type;

        $crontab = $systemReader->read();
        $crontab->clearManagedTasks();

        $configReader = ReaderFactory::create($conf);

        $crontab = $configReader->read();

        $writter = new SystemWriter($conf);

        if ($action == "echo") {
            echo $writter->toCronFile($crontab);
        } else {
            $writter->save($crontab);
        }
        break;
    default:
        error_log("Unknown action.");
}


